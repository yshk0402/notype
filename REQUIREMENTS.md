# notype — REQUIREMENTS.md（ドラフト）

> 本書は `AGENTS.md` を正として同期した要件定義です。

## 1. 概要

### 1.1 目的

* Linux（GNOME）環境で、任意アプリ（例：VS Code）に対して

  * 音声入力 → ローカル音声認識（STT） → アクティブアプリへテキスト入力
    を**軽い操作**で実現する。
* UI は録音コントローラ体験を目指し、Apple っぽい**フローティング・ピル**として常駐させる。

### 1.2 非目的（今回やらない）

* 会議の長時間議事録、話者分離、クラウド共有、チーム機能
* 多言語の高度な自動翻訳・整形（後で拡張は可）
* モバイル連携

### 1.3 提供形態（OSS / インストール / 起動）

* OSS として公開する。
* インストール後、ターミナルから `notype` で起動できる。

  * `notype`：起動（起動済みなら前面化）
  * `notype --settings`：設定ウィンドウを開く（起動済みなら前面化）
  * `notype --quit`：終了（起動済みプロセスへ終了要求）
* 単一インスタンス前提。
* CLI オプションの実装方式：D-Bus
* デスクトップエントリ（.desktop）の提供：提供する
* 配布方式：AppImage 優先（deb / Flatpak は将来対応）

## 2. 想定環境

* OS：Linux
* DE：GNOME

  * Wayland 想定（優先）
  * Xorg でも可能なら動作（優先度低）
* 入力先：フォーカスのある任意アプリ（VS Code を含む）

  * OS レベルの擬似キーボード入力（Wayland 互換を優先）

## 3. 音声認識（コスト要件）

* 最優先：**無料（課金ゼロ）**
* 原則：ローカル音声認識（例：whisper.cpp）
* 例外：ユーザーが明示的に選んだ場合のみクラウド API を許容（ただし MVP ではオプション扱い）

### 3.1 モデル

* 初期：**small を既定**（低レイテンシ優先）
* （拡張）small/medium を切替可能
* モデル配布の扱い：初回起動時ダウンロード（small を既定）

### 3.2 LLM による後処理（精度向上：任意）

* 目的：Whisper の出力テキストを、**句読点付与・誤字補正・文体整形**などで読みやすくする（STT 自体はローカルのまま）
* デフォルト：OFF（API キー未設定でも Whisper だけで十分使える）
* ユーザーが API キーを設定した場合のみ有効化できる

  * 例：Gemini Flash 等の無料枠がある LLM を想定（プロバイダは拡張可能）
* 送信データ方針：原則 **音声は送らず、テキストのみ送信**
* API キー保管：GNOME Keyring（Secret Service）を優先（平文保存を避ける）

## 4. ユースケース

### UC-01: 短時間ディクテーション（主用途）

1. ユーザーは VS Code 等でカーソル位置を決める
2. 常駐ピルで録音開始
3. 発話して録音停止
4. 録音中に partial が逐次更新され、停止後に final が確定する（UI は固まらない）
5. 結果は（設定により）自動でアクティブアプリへ入力される

成功条件：

* 10 秒程度の発話がストレスなく入力される
* 入力先は VS Code に限らず成立

### UC-02: 結果の確認・再入力

* 文字起こし結果を UI 内のテキストフォームに反映し、コピーできる
* Auto-type OFF の場合、「Type」操作で任意タイミングに入力できる

### UC-03: 常駐運用

* ログイン後に自動起動し、常に最前面に表示される
* 画面の邪魔になりにくい（ドラッグ移動、端配置、必要に応じて縮小）

## 5. 機能要件

### 5.1 常駐・ウィンドウ要件

* FR-01：ウィンドウは常に最前面（Always on top）で表示される
* FR-02：フローティング・ピル UI（横長・カプセル形状）として表示される
* FR-03：ユーザーはウィンドウをドラッグで移動できる
* FR-04：初期表示位置は画面右上寄せ（端から 16〜24px マージン）
* FR-05：ログイン時に自動起動できる（GNOME スタートアップに登録可能）
* FR-06：閉じる操作は「終了」または「最小化/隠す」を選べる
  * 既定は「最小化/隠す」（常駐継続）

#### FR-06b：ピル UI 構成（確定）

* ピルはシンプルに **2アイコン** で構成する

  * **設定アイコン**：設定 UI を開く
  * **音声アイコン**：録音開始/停止
* 録音中/処理中/待機の状態が分かる最小の視覚表現（色/インジケータ等）

#### FR-06c：設定 UI（確定：別ウィンドウ）

* 設定アイコン、または `notype --settings` で開ける
* **サイドナビゲーション付き**の設定画面（別ウィンドウ）
* 設定項目：

  * API キー（LLM）
  * LLM 後処理 ON/OFF
  * Auto-type ON/OFF
  * モデル選択（small/medium）
  * 録音最大秒数
  * テキスト整形 ON/OFF

### 5.2 録音制御

* FR-07：録音開始/停止ができる
* FR-08：録音中状態が明確に分かる（視覚的な状態変化）
* FR-09：録音デバイス

  * MVP：default を使用
  * 拡張：デバイス選択
* FR-10：録音時間の上限（例：最大 60 秒）を設け、暴走を防ぐ（設定可能）

### 5.3 音声認識（STT）

* FR-11：録音停止後、音声ファイルをローカルで文字起こしする
* FR-11b：録音中に短チャンクを逐次認識し、partial を 300-700ms 目標で更新する
* FR-12：モデルは少なくとも small / medium を扱える（初期は small）
* FR-13：処理中は UI が固まらない（非同期実行）
* FR-14：結果テキストを UI に表示する（テキストフォームへ反映）
* FR-15：結果テキストの整形（改行潰し、余分な空白除去）を行う（ON/OFF 可）

### 5.4 アクティブアプリへの入力

* FR-16：結果を「今フォーカスしているアプリ」に入力できる
* FR-17：入力方式は Wayland 互換のものを優先（例：wtype）
* FR-18：自動入力（Auto-type）を ON/OFF できる
* FR-19：Auto-type OFF の場合、「Type」操作で手動入力できる
* FR-20：コピー（クリップボード）機能を持つ
* 入力注入のフォールバック：MVP は wtype 中心。ydotool は将来拡張

### 5.5 ショートカット

* FR-21：GNOME 側のカスタムショートカットで起動/録音開始できる（設計上の前提）
* FR-22（拡張）：アプリ内でグローバルホットキー管理
  * Wayland 制約のため MVP 対象外

## 6. UI/UX 要件（Apple っぽい見た目）

### 6.1 デザインシステム（必須）

* UX-01：Apple 風フローティング・ピル
* UX-02：背景はライト基調（例：#F7F7F8 相当）
* UX-03：境界線は極薄（1px / 透明度 6〜10%）
* UX-04：影は 2 層（接地影 + 拡散影）
* UX-05：ボタンは丸ではなく角丸正方形（squircle）寄せ
* UX-06：タイマー等の数字は等幅数字

### 6.2 レイアウト（推奨値）

* ピル高さ：44px
* 角丸：22px
* 左右 Padding：16px
* 要素 gap：12px
* ボタン：28×28px、角丸 8〜10px
* タイマー文字：13〜14px

### 6.3 状態表現（必須）

* Idle：待機状態
* Recording：録音中
* Processing：文字起こし中
* Ready：結果表示・入力可能

## 7. 非機能要件

### 7.1 無料運用

* NFR-01：基本機能は課金ゼロで成立する
* NFR-02：ネットワーク遮断でも動く（LLM OFF で成立）

### 7.2 性能

* NFR-03：10 秒程度の発話で partial 300-700ms 更新、停止後 final 1.5秒以内を目標とする
* NFR-04：UI は常駐しても重くない（常時高負荷を出さない）

### 7.3 信頼性・安全

* NFR-05：録音中プロセスが落ちても復帰できる（状態を戻す）
* NFR-06：一時ファイルの清掃（/tmp 等）
* NFR-07：ユーザーの音声・テキストを外部へ送らない（初期デフォルト）

  * 例外：LLM 後処理を ON にし、かつ API キーを設定した場合のみ（テキストのみ送信）

### 7.4 互換性

* NFR-08：Wayland 環境での入力注入が可能（wtype 等）
* NFR-09：Xorg でも可能なら動く（ただし優先度は Wayland）

## 8. 設定項目

### 8.1 MVP

* 録音最大秒数（例：60）
* モデル選択（small/medium）
* Auto-type ON/OFF
* 整形 ON/OFF（改行潰し）
* realtime 有効（既定 ON）
* partial auto-type replace（experimental）

### 8.2 拡張

* LLM 後処理 ON/OFF（句読点付与・誤字補正など）
* LLM プロバイダ選択（例：Gemini Flash 等）
* API キー設定（安全な保管）
* 後処理プロンプト / ルール（テンプレ）
* 入力前「確認」ダイアログ
* 日本語句読点付与、文体整形
* マイクデバイス選択
* ピルの不透明度、常に最前面 ON/OFF

## 9. MVP 受け入れ基準（テスト観点）

> MVP 完了判定は AC-01〜AC-08 とする。AC-09〜AC-11 は実装を維持しつつ、実機検証は次フェーズで完了させる。

* AC-01：VS Code にカーソル → 10 秒話して停止 → 結果が入力される（Auto-type ON）
* AC-02：Auto-type OFF → 結果表示 → 「Type」押下で入力される
* AC-03：録音→処理中でも UI が固まらない
* AC-04：ウィンドウが常に最前面で、ドラッグ移動できる
* AC-05：ログイン後に自動起動できる
* AC-06：ネットワークを切っても動く（LLM OFF）
* AC-07：`notype --settings` で設定ウィンドウが開く（起動済みなら前面化）
* AC-08：`notype --quit` で終了できる
* AC-09：録音中に partial が 300-700ms で更新される
* AC-10：partial 置換注入が動作し、失敗時は同セッションで final のみ注入へ降格
* AC-11：LLM OFF でネットワーク遮断下でも動作し、音声は外部送信されない

## 10. 既知リスク・論点

* Wayland でのグローバルホットキーは制約が出やすい

  * 回避：GNOME 設定のカスタムショートカットで回避する
* 入力注入は環境依存（wtype が通らないケース）

  * 代替（ydotool 等）を用意する設計が無難
* モデルが重いと待ち時間が伸びる

  * small/medium 切替と録音時間制限が必須
